name: release

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Resolve release metadata
        id: meta
        run: |
          set -euo pipefail
          LATEST_STABLE_TAG="$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n1 || true)"
          NEXT_DEV_BASE="0.1.0"
          if [[ -n "${LATEST_STABLE_TAG}" ]] && [[ "${LATEST_STABLE_TAG}" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            major="${BASH_REMATCH[1]}"
            minor="${BASH_REMATCH[2]}"
            patch="${BASH_REMATCH[3]}"
            NEXT_DEV_BASE="${major}.${minor}.$((patch + 1))"
          fi

          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF_NAME}"
            PRERELEASE=false
            if [[ "${TAG}" == *-* ]]; then
              PRERELEASE=true
            fi
            NAME="${TAG}"
            VERSION="${TAG}"
          else
            TAG="v${NEXT_DEV_BASE}-dev.${GITHUB_RUN_NUMBER}"
            PRERELEASE=true
            NAME="${TAG}"
            VERSION="${TAG}"
          fi

          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "name=${NAME}" >> "${GITHUB_OUTPUT}"
          echo "prerelease=${PRERELEASE}" >> "${GITHUB_OUTPUT}"

      - name: Build release artifacts
        env:
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          set -euo pipefail

          BIN_NAME="yt-vod-manager"
          DIST_DIR="dist"
          mkdir -p "${DIST_DIR}"

          targets=(
            "darwin amd64 tar.gz"
            "darwin arm64 tar.gz"
            "linux amd64 tar.gz"
            "linux arm64 tar.gz"
            "windows amd64 zip"
          )

          for target in "${targets[@]}"; do
            read -r GOOS GOARCH ARCHIVE <<<"${target}"
            EXE=""
            if [[ "${GOOS}" == "windows" ]]; then
              EXE=".exe"
            fi

            PACKAGE_BASE="${BIN_NAME}_${VERSION}_${GOOS}_${GOARCH}"
            STAGE_DIR="${DIST_DIR}/${PACKAGE_BASE}"

            mkdir -p "${STAGE_DIR}"
            CGO_ENABLED=0 GOOS="${GOOS}" GOARCH="${GOARCH}" \
              go build -trimpath -o "${STAGE_DIR}/${BIN_NAME}${EXE}" ./cmd/yt-vod-manager

            cp README.md LICENSE "${STAGE_DIR}/"

            if [[ "${ARCHIVE}" == "zip" ]]; then
              (cd "${DIST_DIR}" && zip -rq "${PACKAGE_BASE}.zip" "${PACKAGE_BASE}")
            else
              tar -C "${DIST_DIR}" -czf "${DIST_DIR}/${PACKAGE_BASE}.tar.gz" "${PACKAGE_BASE}"
            fi

            rm -rf "${STAGE_DIR}"
          done

          CHECKSUM_FILE="${DIST_DIR}/${BIN_NAME}_${VERSION}_checksums.txt"
          if command -v sha256sum >/dev/null 2>&1; then
            (cd "${DIST_DIR}" && sha256sum "${BIN_NAME}_${VERSION}_"* > "$(basename "${CHECKSUM_FILE}")")
          else
            (cd "${DIST_DIR}" && shasum -a 256 "${BIN_NAME}_${VERSION}_"* > "$(basename "${CHECKSUM_FILE}")")
          fi

      - name: Build release changelog
        env:
          RELEASE_TAG: ${{ steps.meta.outputs.tag }}
        run: |
          set -euo pipefail
          mkdir -p dist

          PREV_TAG="$(git tag --list 'v*' --sort=-creatordate | grep -Fxv "${RELEASE_TAG}" | head -n1 || true)"
          if [[ -n "${PREV_TAG}" ]]; then
            CHANGES="$(git log --no-merges --pretty='- %s (%h)' "${PREV_TAG}..HEAD" || true)"
            RANGE_NOTE="Changes since \`${PREV_TAG}\`."
          else
            CHANGES="$(git log --no-merges --pretty='- %s (%h)' || true)"
            RANGE_NOTE="Initial release changelog."
          fi
          if [[ -z "${CHANGES// }" ]]; then
            CHANGES="- No user-facing changes in this release."
          fi

          {
            echo "## Changelog"
            echo
            echo "${RANGE_NOTE}"
            echo
            echo "${CHANGES}"
          } > dist/RELEASE_NOTES.md

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          files: dist/*
          body_path: dist/RELEASE_NOTES.md
          prerelease: ${{ steps.meta.outputs.prerelease == 'true' }}
