name: release

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
      version_no_v: ${{ steps.meta.outputs.version_no_v }}
      stable: ${{ steps.meta.outputs.stable }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Resolve release metadata
        id: meta
        run: |
          set -euo pipefail
          LATEST_STABLE_TAG="$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n1 || true)"
          NEXT_DEV_BASE="0.1.0"
          if [[ -n "${LATEST_STABLE_TAG}" ]] && [[ "${LATEST_STABLE_TAG}" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            major="${BASH_REMATCH[1]}"
            minor="${BASH_REMATCH[2]}"
            patch="${BASH_REMATCH[3]}"
            NEXT_DEV_BASE="${major}.${minor}.$((patch + 1))"
          fi

          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF_NAME}"
            PRERELEASE=false
            STABLE=false
            if [[ "${TAG}" == *-* ]]; then
              PRERELEASE=true
            else
              STABLE=true
            fi
            NAME="${TAG}"
            VERSION="${TAG}"
          else
            TAG="v${NEXT_DEV_BASE}-dev.${GITHUB_RUN_NUMBER}"
            PRERELEASE=true
            STABLE=false
            NAME="${TAG}"
            VERSION="${TAG}"
          fi

          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "version_no_v=${VERSION#v}" >> "${GITHUB_OUTPUT}"
          echo "name=${NAME}" >> "${GITHUB_OUTPUT}"
          echo "prerelease=${PRERELEASE}" >> "${GITHUB_OUTPUT}"
          echo "stable=${STABLE}" >> "${GITHUB_OUTPUT}"

      - name: Build release artifacts
        env:
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          set -euo pipefail

          BIN_NAME="yt-vod-manager"
          DIST_DIR="dist"
          mkdir -p "${DIST_DIR}"

          targets=(
            "darwin amd64 tar.gz"
            "darwin arm64 tar.gz"
            "linux amd64 tar.gz"
            "linux arm64 tar.gz"
            "windows amd64 zip"
          )

          for target in "${targets[@]}"; do
            read -r GOOS GOARCH ARCHIVE <<<"${target}"
            EXE=""
            if [[ "${GOOS}" == "windows" ]]; then
              EXE=".exe"
            fi

            PACKAGE_BASE="${BIN_NAME}_${VERSION}_${GOOS}_${GOARCH}"
            STAGE_DIR="${DIST_DIR}/${PACKAGE_BASE}"

            mkdir -p "${STAGE_DIR}"
            CGO_ENABLED=0 GOOS="${GOOS}" GOARCH="${GOARCH}" \
              go build -trimpath -o "${STAGE_DIR}/${BIN_NAME}${EXE}" ./cmd/yt-vod-manager

            cp README.md LICENSE "${STAGE_DIR}/"

            if [[ "${ARCHIVE}" == "zip" ]]; then
              (cd "${DIST_DIR}" && zip -rq "${PACKAGE_BASE}.zip" "${PACKAGE_BASE}")
            else
              tar -C "${DIST_DIR}" -czf "${DIST_DIR}/${PACKAGE_BASE}.tar.gz" "${PACKAGE_BASE}"
            fi

            rm -rf "${STAGE_DIR}"
          done

          CHECKSUM_FILE="${DIST_DIR}/${BIN_NAME}_${VERSION}_checksums.txt"
          if command -v sha256sum >/dev/null 2>&1; then
            (cd "${DIST_DIR}" && sha256sum "${BIN_NAME}_${VERSION}_"* > "$(basename "${CHECKSUM_FILE}")")
          else
            (cd "${DIST_DIR}" && shasum -a 256 "${BIN_NAME}_${VERSION}_"* > "$(basename "${CHECKSUM_FILE}")")
          fi

      - name: Build WinGet manifests
        if: ${{ steps.meta.outputs.stable == 'true' }}
        env:
          VERSION: ${{ steps.meta.outputs.version }}
          VERSION_NO_V: ${{ steps.meta.outputs.version_no_v }}
        run: |
          set -euo pipefail

          WINDOWS_FILE="yt-vod-manager_${VERSION}_windows_amd64.zip"
          WINDOWS_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${VERSION}/${WINDOWS_FILE}"

          sha_file() {
            if command -v sha256sum >/dev/null 2>&1; then
              sha256sum "$1" | awk '{print $1}'
            else
              shasum -a 256 "$1" | awk '{print $1}'
            fi
          }

          WINDOWS_SHA="$(sha_file "dist/${WINDOWS_FILE}")"
          OUT_ROOT="dist/winget"

          ./packaging/winget/generate-manifests.sh \
            --version "${VERSION_NO_V}" \
            --release-tag "${VERSION}" \
            --installer-url "${WINDOWS_URL}" \
            --installer-sha "${WINDOWS_SHA}" \
            --release-date "$(date -u +%F)" \
            --out-root "${OUT_ROOT}"

          (cd "${OUT_ROOT}" && zip -rq "../winget-manifests_${VERSION}.zip" manifests)
          rm -rf "${OUT_ROOT}"

      - name: Build release changelog
        env:
          RELEASE_TAG: ${{ steps.meta.outputs.tag }}
        run: |
          set -euo pipefail
          mkdir -p dist

          PREV_TAG="$(git tag --list 'v*' --sort=-creatordate | grep -Fxv "${RELEASE_TAG}" | head -n1 || true)"
          if [[ -n "${PREV_TAG}" ]]; then
            CHANGES="$(git log --no-merges --pretty='- %s (%h)' "${PREV_TAG}..HEAD" || true)"
            RANGE_NOTE="Changes since \`${PREV_TAG}\`."
          else
            CHANGES="$(git log --no-merges --pretty='- %s (%h)' || true)"
            RANGE_NOTE="Initial release changelog."
          fi
          if [[ -z "${CHANGES// }" ]]; then
            CHANGES="- No user-facing changes in this release."
          fi

          {
            echo "## Changelog"
            echo
            echo "${RANGE_NOTE}"
            echo
            echo "${CHANGES}"
          } > dist/RELEASE_NOTES.md

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          files: dist/*
          body_path: dist/RELEASE_NOTES.md
          prerelease: ${{ steps.meta.outputs.prerelease == 'true' }}

      - name: Setup Node for npm publish
        if: ${{ steps.meta.outputs.stable == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: npm publish
        if: ${{ steps.meta.outputs.stable == 'true' }}
        env:
          PACKAGE_NAME: "@marcohefti/yt-vod-manager"
          VERSION_NO_V: ${{ steps.meta.outputs.version_no_v }}
        run: |
          set -euo pipefail
          if npm view "${PACKAGE_NAME}@${VERSION_NO_V}" version >/dev/null 2>&1; then
            echo "${PACKAGE_NAME}@${VERSION_NO_V} already published; skipping npm publish."
            exit 0
          fi
          cd packaging/npm
          npm version --no-git-tag-version "${VERSION_NO_V}"
          npm publish --provenance --access public --ignore-scripts

      - name: Update Homebrew tap
        if: ${{ steps.meta.outputs.stable == 'true' }}
        env:
          VERSION: ${{ steps.meta.outputs.version }}
          VERSION_NO_V: ${{ steps.meta.outputs.version_no_v }}
          TAP_REPO: marcohefti/homebrew-yt-vod-manager
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${HOMEBREW_TAP_GITHUB_TOKEN:-}" ]]; then
            echo "HOMEBREW_TAP_GITHUB_TOKEN is not set; skipping Homebrew tap update."
            exit 0
          fi

          DARWIN_AMD64_FILE="yt-vod-manager_${VERSION}_darwin_amd64.tar.gz"
          DARWIN_ARM64_FILE="yt-vod-manager_${VERSION}_darwin_arm64.tar.gz"
          LINUX_AMD64_FILE="yt-vod-manager_${VERSION}_linux_amd64.tar.gz"
          LINUX_ARM64_FILE="yt-vod-manager_${VERSION}_linux_arm64.tar.gz"

          sha_file() {
            if command -v sha256sum >/dev/null 2>&1; then
              sha256sum "$1" | awk '{print $1}'
            else
              shasum -a 256 "$1" | awk '{print $1}'
            fi
          }

          DARWIN_AMD64_SHA="$(sha_file "dist/${DARWIN_AMD64_FILE}")"
          DARWIN_ARM64_SHA="$(sha_file "dist/${DARWIN_ARM64_FILE}")"
          LINUX_AMD64_SHA="$(sha_file "dist/${LINUX_AMD64_FILE}")"
          LINUX_ARM64_SHA="$(sha_file "dist/${LINUX_ARM64_FILE}")"

          rm -rf tap
          git clone "https://x-access-token:${HOMEBREW_TAP_GITHUB_TOKEN}@github.com/${TAP_REPO}.git" tap
          mkdir -p tap/Formula

          cat > tap/Formula/yt-vod-manager.rb <<EOF
          class YtVodManager < Formula
            desc "CLI app to download YouTube channels and playlists and keep them up to date locally"
            homepage "https://github.com/marcohefti/yt-vod-manager"
            version "${VERSION_NO_V}"

            if OS.mac?
              if Hardware::CPU.arm?
                url "https://github.com/marcohefti/yt-vod-manager/releases/download/${VERSION}/${DARWIN_ARM64_FILE}"
                sha256 "${DARWIN_ARM64_SHA}"
              else
                url "https://github.com/marcohefti/yt-vod-manager/releases/download/${VERSION}/${DARWIN_AMD64_FILE}"
                sha256 "${DARWIN_AMD64_SHA}"
              end
            elsif OS.linux?
              if Hardware::CPU.arm?
                url "https://github.com/marcohefti/yt-vod-manager/releases/download/${VERSION}/${LINUX_ARM64_FILE}"
                sha256 "${LINUX_ARM64_SHA}"
              else
                url "https://github.com/marcohefti/yt-vod-manager/releases/download/${VERSION}/${LINUX_AMD64_FILE}"
                sha256 "${LINUX_AMD64_SHA}"
              end
            end

            def install
              bin.install "yt-vod-manager"
              prefix.install "README.md", "LICENSE"
            end

            test do
              assert_match "yt-vod-manager", shell_output("#{bin}/yt-vod-manager --help")
            end
          end
          EOF

          cd tap
          git add Formula/yt-vod-manager.rb
          if git diff --cached --quiet -- Formula/yt-vod-manager.rb; then
            echo "No Homebrew formula changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "yt-vod-manager ${VERSION_NO_V}"
          git push origin HEAD:main

  publish-winget:
    needs: publish
    if: ${{ needs.publish.outputs.stable == 'true' }}
    runs-on: windows-latest
    env:
      PACKAGE_ID: MarcoHefti.YTVodManager
      RELEASE_TAG: ${{ needs.publish.outputs.tag }}
      VERSION_NO_V: ${{ needs.publish.outputs.version_no_v }}
      REPOSITORY: ${{ github.repository }}
      WINGET_CREATE_GITHUB_TOKEN: ${{ secrets.WINGET_CREATE_GITHUB_TOKEN }}
    steps:
      - name: Check WinGet submit prerequisites
        id: prereq
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace($env:WINGET_CREATE_GITHUB_TOKEN)) {
            Write-Host "WINGET_CREATE_GITHUB_TOKEN is not set; skipping WinGet submit."
            "ready=false" >> $env:GITHUB_OUTPUT
            exit 0
          }

          $assetUrl = "https://github.com/$env:REPOSITORY/releases/download/$env:RELEASE_TAG/yt-vod-manager_$($env:RELEASE_TAG)_windows_amd64.zip"
          "asset_url=$assetUrl" >> $env:GITHUB_OUTPUT

          $packagePath = "https://api.github.com/repos/microsoft/winget-pkgs/contents/manifests/m/MarcoHefti/YTVodManager?ref=master"
          $statusCode = & curl.exe -s -o NUL -w "%{http_code}" $packagePath
          if ($statusCode -eq "200") {
            "package_exists=true" >> $env:GITHUB_OUTPUT
          } elseif ($statusCode -eq "404") {
            Write-Host "WinGet package path not found yet; skipping auto-submit."
            "package_exists=false" >> $env:GITHUB_OUTPUT
          } else {
            throw "Unexpected HTTP status checking WinGet package path: $statusCode"
          }

          $versionPath = "https://api.github.com/repos/microsoft/winget-pkgs/contents/manifests/m/MarcoHefti/YTVodManager/$env:VERSION_NO_V?ref=master"
          $versionStatus = & curl.exe -s -o NUL -w "%{http_code}" $versionPath
          if ($versionStatus -eq "200") {
            Write-Host "WinGet manifest version already exists; skipping submit."
            "version_exists=true" >> $env:GITHUB_OUTPUT
          } elseif ($versionStatus -eq "404") {
            "version_exists=false" >> $env:GITHUB_OUTPUT
          } else {
            throw "Unexpected HTTP status checking WinGet version path: $versionStatus"
          }

          "ready=true" >> $env:GITHUB_OUTPUT

      - name: Submit WinGet manifest update
        if: ${{ steps.prereq.outputs.ready == 'true' && steps.prereq.outputs.package_exists == 'true' && steps.prereq.outputs.version_exists != 'true' }}
        shell: pwsh
        run: |
          curl.exe -JLO https://aka.ms/wingetcreate/latest

          $releaseNotesUrl = "https://github.com/$env:REPOSITORY/releases/tag/$env:RELEASE_TAG"
          $releaseDate = Get-Date -AsUTC -Format "yyyy-MM-dd"

          .\wingetcreate.exe update $env:PACKAGE_ID `
            --version $env:VERSION_NO_V `
            --urls "${{ steps.prereq.outputs.asset_url }}" `
            --release-date $releaseDate `
            --release-notes-url $releaseNotesUrl `
            --submit

      - name: WinGet package bootstrap notice
        if: ${{ steps.prereq.outputs.ready == 'true' && steps.prereq.outputs.package_exists != 'true' }}
        shell: pwsh
        run: |
          Write-Host "Run the first submission manually in microsoft/winget-pkgs, then later releases will auto-submit updates."

      - name: WinGet version already exists notice
        if: ${{ steps.prereq.outputs.ready == 'true' && steps.prereq.outputs.package_exists == 'true' && steps.prereq.outputs.version_exists == 'true' }}
        shell: pwsh
        run: |
          Write-Host "WinGet manifest version already exists in microsoft/winget-pkgs; skipping submit."
