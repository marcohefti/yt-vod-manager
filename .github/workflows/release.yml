name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Stable version without leading v (example: 0.1.9)"
        required: true
        type: string

permissions:
  actions: read
  contents: write
  id-token: write

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version_no_v: ${{ steps.meta.outputs.version_no_v }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Resolve and validate release version
        id: meta
        env:
          VERSION_INPUT: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail

          if [[ "${GITHUB_REF_NAME}" != "main" ]]; then
            echo "Release workflow must be run from main. Current ref: ${GITHUB_REF_NAME}" >&2
            exit 1
          fi

          VERSION_NO_V="${VERSION_INPUT}"
          if [[ ! "${VERSION_NO_V}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version '${VERSION_NO_V}'. Use SemVer without leading v (example: 0.1.9)." >&2
            exit 1
          fi

          TAG="v${VERSION_NO_V}"
          echo "version_no_v=${VERSION_NO_V}" >> "${GITHUB_OUTPUT}"
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"

      - name: Verify readiness and CI succeeded on this commit
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          check_workflow_success() {
            local workflow="$1"
            local runs
            local success_count

            runs="$(gh run list --workflow "$workflow" --commit "$GITHUB_SHA" --json headSha,status,conclusion,databaseId --limit 20)"
            success_count="$(echo "$runs" | jq --arg sha "$GITHUB_SHA" '[.[] | select(.headSha==$sha and .status=="completed" and .conclusion=="success")] | length')"

            if [[ "$success_count" -lt 1 ]]; then
              echo "No successful '$workflow' run found for commit $GITHUB_SHA." >&2
              echo "$runs" >&2
              exit 1
            fi
          }

          check_workflow_success "ci"
          check_workflow_success "release-readiness"

      - name: Verify version has not been published already
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION_NO_V: ${{ steps.meta.outputs.version_no_v }}
          TAG: ${{ steps.meta.outputs.tag }}
          PACKAGE_NAME: "@marcohefti/yt-vod-manager"
        run: |
          set -euo pipefail

          git fetch --tags --force

          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Git tag ${TAG} already exists." >&2
            exit 1
          fi

          if gh release view "${TAG}" --repo "${GITHUB_REPOSITORY}" >/dev/null 2>&1; then
            echo "GitHub release ${TAG} already exists." >&2
            exit 1
          fi

          if npm view "${PACKAGE_NAME}@${VERSION_NO_V}" version >/dev/null 2>&1; then
            echo "npm package ${PACKAGE_NAME}@${VERSION_NO_V} already exists." >&2
            exit 1
          fi

          if curl -fsSL "https://raw.githubusercontent.com/marcohefti/homebrew-yt-vod-manager/main/Formula/yt-vod-manager.rb" | grep -q "version \"${VERSION_NO_V}\""; then
            echo "Homebrew formula already references version ${VERSION_NO_V}." >&2
            exit 1
          fi

  publish:
    needs: preflight
    outputs:
      tag: ${{ needs.preflight.outputs.tag }}
      version_no_v: ${{ needs.preflight.outputs.version_no_v }}
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.preflight.outputs.tag }}
      VERSION_NO_V: ${{ needs.preflight.outputs.version_no_v }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build release artifacts
        run: |
          set -euo pipefail

          BIN_NAME="yt-vod-manager"
          DIST_DIR="dist"
          mkdir -p "${DIST_DIR}"

          targets=(
            "darwin amd64 tar.gz"
            "darwin arm64 tar.gz"
            "linux amd64 tar.gz"
            "linux arm64 tar.gz"
            "windows amd64 zip"
          )

          for target in "${targets[@]}"; do
            read -r GOOS GOARCH ARCHIVE <<<"${target}"
            EXE=""
            if [[ "${GOOS}" == "windows" ]]; then
              EXE=".exe"
            fi

            PACKAGE_BASE="${BIN_NAME}_${VERSION}_${GOOS}_${GOARCH}"
            STAGE_DIR="${DIST_DIR}/${PACKAGE_BASE}"

            mkdir -p "${STAGE_DIR}"
            CGO_ENABLED=0 GOOS="${GOOS}" GOARCH="${GOARCH}" \
              go build -trimpath -ldflags "-X yt-vod-manager/internal/version.Value=${VERSION}" -o "${STAGE_DIR}/${BIN_NAME}${EXE}" ./cmd/yt-vod-manager

            cp README.md LICENSE "${STAGE_DIR}/"

            if [[ "${ARCHIVE}" == "zip" ]]; then
              (cd "${DIST_DIR}" && zip -rq "${PACKAGE_BASE}.zip" "${PACKAGE_BASE}")
            else
              tar -C "${DIST_DIR}" -czf "${DIST_DIR}/${PACKAGE_BASE}.tar.gz" "${PACKAGE_BASE}"
            fi

            rm -rf "${STAGE_DIR}"
          done

          CHECKSUM_FILE="${DIST_DIR}/${BIN_NAME}_${VERSION}_checksums.txt"
          if command -v sha256sum >/dev/null 2>&1; then
            (cd "${DIST_DIR}" && sha256sum "${BIN_NAME}_${VERSION}_"* > "$(basename "${CHECKSUM_FILE}")")
          else
            (cd "${DIST_DIR}" && shasum -a 256 "${BIN_NAME}_${VERSION}_"* > "$(basename "${CHECKSUM_FILE}")")
          fi

      - name: Build WinGet manifests
        run: |
          set -euo pipefail

          WINDOWS_FILE="yt-vod-manager_${VERSION}_windows_amd64.zip"
          WINDOWS_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${VERSION}/${WINDOWS_FILE}"

          sha_file() {
            if command -v sha256sum >/dev/null 2>&1; then
              sha256sum "$1" | awk '{print $1}'
            else
              shasum -a 256 "$1" | awk '{print $1}'
            fi
          }

          WINDOWS_SHA="$(sha_file "dist/${WINDOWS_FILE}")"
          OUT_ROOT="dist/winget"

          ./packaging/winget/generate-manifests.sh \
            --version "${VERSION_NO_V}" \
            --release-tag "${VERSION}" \
            --installer-url "${WINDOWS_URL}" \
            --installer-sha "${WINDOWS_SHA}" \
            --release-date "$(date -u +%F)" \
            --out-root "${OUT_ROOT}"

          (cd "${OUT_ROOT}" && zip -rq "../winget-manifests_${VERSION}.zip" manifests)
          rm -rf "${OUT_ROOT}"

      - name: Build release changelog
        env:
          RELEASE_TAG: ${{ needs.preflight.outputs.tag }}
        run: |
          set -euo pipefail
          mkdir -p dist

          PREV_TAG="$(git tag --list 'v*' --sort=-creatordate | grep -Fxv "${RELEASE_TAG}" | head -n1 || true)"
          if [[ -n "${PREV_TAG}" ]]; then
            CHANGES="$(git log --no-merges --pretty='- %s (%h)' "${PREV_TAG}..HEAD" || true)"
            RANGE_NOTE="Changes since \`${PREV_TAG}\`."
          else
            CHANGES="$(git log --no-merges --pretty='- %s (%h)' || true)"
            RANGE_NOTE="Initial release changelog."
          fi
          if [[ -z "${CHANGES// }" ]]; then
            CHANGES="- No user-facing changes in this release."
          fi

          {
            echo "## Changelog"
            echo
            echo "${RANGE_NOTE}"
            echo
            echo "${CHANGES}"
          } > dist/RELEASE_NOTES.md

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.preflight.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: ${{ needs.preflight.outputs.tag }}
          files: dist/*
          body_path: dist/RELEASE_NOTES.md
          prerelease: false

      - name: Setup Node for npm publish
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: npm publish
        env:
          PACKAGE_NAME: "@marcohefti/yt-vod-manager"
        run: |
          set -euo pipefail
          if npm view "${PACKAGE_NAME}@${VERSION_NO_V}" version >/dev/null 2>&1; then
            echo "${PACKAGE_NAME}@${VERSION_NO_V} already published; skipping npm publish."
            exit 0
          fi
          cd packaging/npm
          npm version --no-git-tag-version "${VERSION_NO_V}"
          npm publish --provenance --access public --ignore-scripts

      - name: Update Homebrew tap
        env:
          TAP_REPO: marcohefti/homebrew-yt-vod-manager
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${HOMEBREW_TAP_GITHUB_TOKEN:-}" ]]; then
            echo "HOMEBREW_TAP_GITHUB_TOKEN is not set; skipping Homebrew tap update."
            exit 0
          fi

          DARWIN_AMD64_FILE="yt-vod-manager_${VERSION}_darwin_amd64.tar.gz"
          DARWIN_ARM64_FILE="yt-vod-manager_${VERSION}_darwin_arm64.tar.gz"
          LINUX_AMD64_FILE="yt-vod-manager_${VERSION}_linux_amd64.tar.gz"
          LINUX_ARM64_FILE="yt-vod-manager_${VERSION}_linux_arm64.tar.gz"

          sha_file() {
            if command -v sha256sum >/dev/null 2>&1; then
              sha256sum "$1" | awk '{print $1}'
            else
              shasum -a 256 "$1" | awk '{print $1}'
            fi
          }

          DARWIN_AMD64_SHA="$(sha_file "dist/${DARWIN_AMD64_FILE}")"
          DARWIN_ARM64_SHA="$(sha_file "dist/${DARWIN_ARM64_FILE}")"
          LINUX_AMD64_SHA="$(sha_file "dist/${LINUX_AMD64_FILE}")"
          LINUX_ARM64_SHA="$(sha_file "dist/${LINUX_ARM64_FILE}")"

          rm -rf tap
          git clone "https://x-access-token:${HOMEBREW_TAP_GITHUB_TOKEN}@github.com/${TAP_REPO}.git" tap
          mkdir -p tap/Formula

          cat > tap/Formula/yt-vod-manager.rb <<EOF2
          class YtVodManager < Formula
            desc "CLI app to download YouTube channels and playlists and keep them up to date locally"
            homepage "https://github.com/marcohefti/yt-vod-manager"
            version "${VERSION_NO_V}"

            if OS.mac?
              if Hardware::CPU.arm?
                url "https://github.com/marcohefti/yt-vod-manager/releases/download/${VERSION}/${DARWIN_ARM64_FILE}"
                sha256 "${DARWIN_ARM64_SHA}"
              else
                url "https://github.com/marcohefti/yt-vod-manager/releases/download/${VERSION}/${DARWIN_AMD64_FILE}"
                sha256 "${DARWIN_AMD64_SHA}"
              end
            elsif OS.linux?
              if Hardware::CPU.arm?
                url "https://github.com/marcohefti/yt-vod-manager/releases/download/${VERSION}/${LINUX_ARM64_FILE}"
                sha256 "${LINUX_ARM64_SHA}"
              else
                url "https://github.com/marcohefti/yt-vod-manager/releases/download/${VERSION}/${LINUX_AMD64_FILE}"
                sha256 "${LINUX_AMD64_SHA}"
              end
            end

            def install
              bin.install "yt-vod-manager"
              prefix.install "README.md", "LICENSE"
            end

            test do
              assert_match "yt-vod-manager", shell_output("#{bin}/yt-vod-manager --help")
            end
          end
          EOF2

          cd tap
          git add Formula/yt-vod-manager.rb
          if git diff --cached --quiet -- Formula/yt-vod-manager.rb; then
            echo "No Homebrew formula changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "yt-vod-manager ${VERSION_NO_V}"
          git push origin HEAD:main

  publish-winget:
    needs: publish
    runs-on: windows-latest
    env:
      PACKAGE_ID: MarcoHefti.YTVodManager
      RELEASE_TAG: ${{ needs.publish.outputs.tag }}
      VERSION_NO_V: ${{ needs.publish.outputs.version_no_v }}
      REPOSITORY: ${{ github.repository }}
      WINGET_CREATE_GITHUB_TOKEN: ${{ secrets.WINGET_CREATE_GITHUB_TOKEN }}
    steps:
      - name: Check WinGet submit prerequisites
        id: prereq
        env:
          GH_TOKEN: ${{ secrets.WINGET_CREATE_GITHUB_TOKEN }}
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace($env:WINGET_CREATE_GITHUB_TOKEN)) {
            Write-Host "WINGET_CREATE_GITHUB_TOKEN is not set; skipping WinGet submit."
            "ready=false" >> $env:GITHUB_OUTPUT
            exit 0
          }

          $assetUrl = "https://github.com/$env:REPOSITORY/releases/download/$env:RELEASE_TAG/yt-vod-manager_$($env:RELEASE_TAG)_windows_amd64.zip"
          "asset_url=$assetUrl" >> $env:GITHUB_OUTPUT

          $packagePath = "https://api.github.com/repos/microsoft/winget-pkgs/contents/manifests/m/MarcoHefti/YTVodManager?ref=master"
          $statusCode = & curl.exe -s -o NUL -w "%{http_code}" $packagePath
          if ($statusCode -eq "200") {
            "package_exists=true" >> $env:GITHUB_OUTPUT
          } elseif ($statusCode -eq "404") {
            Write-Host "WinGet package path not found yet; skipping auto-submit."
            "package_exists=false" >> $env:GITHUB_OUTPUT
          } else {
            throw "Unexpected HTTP status checking WinGet package path: $statusCode"
          }

          $versionPath = "https://api.github.com/repos/microsoft/winget-pkgs/contents/manifests/m/MarcoHefti/YTVodManager/$env:VERSION_NO_V?ref=master"
          $versionStatus = & curl.exe -s -o NUL -w "%{http_code}" $versionPath
          if ($versionStatus -eq "200") {
            Write-Host "WinGet manifest version already exists; skipping submit."
            "version_exists=true" >> $env:GITHUB_OUTPUT
          } elseif ($versionStatus -eq "404") {
            "version_exists=false" >> $env:GITHUB_OUTPUT
          } else {
            throw "Unexpected HTTP status checking WinGet version path: $versionStatus"
          }

          $openPrs = gh pr list -R microsoft/winget-pkgs --state open --json number,title,url | ConvertFrom-Json
          $openPackagePrs = @($openPrs | Where-Object {
            $_.title -like "New version: $($env:PACKAGE_ID) version *" -or $_.title -like "Add $($env:PACKAGE_ID) version *"
          })
          if ($openPackagePrs.Count -gt 0) {
            $first = $openPackagePrs | Select-Object -First 1
            Write-Host "Open WinGet PR already exists for $env:PACKAGE_ID: $($first.url). Skipping submit to avoid parallel package PRs."
            "open_pr_exists=true" >> $env:GITHUB_OUTPUT
            "open_pr_url=$($first.url)" >> $env:GITHUB_OUTPUT
            "ready=false" >> $env:GITHUB_OUTPUT
            exit 0
          }
          "open_pr_exists=false" >> $env:GITHUB_OUTPUT

          "ready=true" >> $env:GITHUB_OUTPUT

      - name: Validate generated WinGet manifest and smoke-install
        id: winget_validate
        if: ${{ steps.prereq.outputs.ready == 'true' && steps.prereq.outputs.package_exists == 'true' && steps.prereq.outputs.version_exists != 'true' }}
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $assetFile = "winget-manifests_${env:RELEASE_TAG}.zip"
          $assetUrl = "https://github.com/$env:REPOSITORY/releases/download/$env:RELEASE_TAG/$assetFile"
          Write-Host "Downloading manifest archive: $assetUrl"
          Invoke-WebRequest -Uri $assetUrl -OutFile $assetFile

          if (-not (Test-Path $assetFile)) {
            throw "WinGet manifest archive was not downloaded: $assetFile"
          }
          if ((Get-Item $assetFile).Length -le 0) {
            throw "WinGet manifest archive is empty: $assetFile"
          }

          if (Test-Path winget-manifests) {
            Remove-Item -Recurse -Force winget-manifests
          }
          Expand-Archive -Path $assetFile -DestinationPath winget-manifests -Force

          $manifestPath = Join-Path (Join-Path (Join-Path "winget-manifests" "manifests") "m") ($env:PACKAGE_ID -replace "\.", "/")
          $manifestPath = Join-Path $manifestPath $env:VERSION_NO_V
          if (-not (Test-Path $manifestPath)) {
            throw "Expected manifest directory not found: $manifestPath"
          }

          "manifest_path=$manifestPath" >> $env:GITHUB_OUTPUT
          winget validate --manifest "$manifestPath"
          if ($LASTEXITCODE -ne 0) {
            throw "winget validate failed for $manifestPath"
          }

          winget settings --enable LocalManifestFiles
          if ($LASTEXITCODE -ne 0) {
            throw "failed to enable LocalManifestFiles for winget manifest install"
          }

          winget install --manifest "$manifestPath" --accept-source-agreements --accept-package-agreements --disable-interactivity --silent
          if ($LASTEXITCODE -ne 0) {
            throw "winget install from manifest failed for $manifestPath"
          }

      - name: Submit WinGet manifest update
        id: winget_submit
        if: ${{ steps.prereq.outputs.ready == 'true' && steps.prereq.outputs.package_exists == 'true' && steps.prereq.outputs.version_exists != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.WINGET_CREATE_GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          curl.exe -JLO https://aka.ms/wingetcreate/latest

          $releaseNotesUrl = "https://github.com/$env:REPOSITORY/releases/tag/$env:RELEASE_TAG"
          $releaseDate = Get-Date -AsUTC -Format "yyyy-MM-dd"

          $submitOutput = .\wingetcreate.exe update $env:PACKAGE_ID `
            --version $env:VERSION_NO_V `
            --urls "${{ steps.prereq.outputs.asset_url }}" `
            --release-date $releaseDate `
            --release-notes-url $releaseNotesUrl `
            --submit
          $submitOutput

          $outputText = $submitOutput -join "`n"
          $match = [regex]::Match($outputText, "https://github\\.com/microsoft/winget-pkgs/pull/\\d+")
          if ($match.Success) {
            "pull_request_url=$($match.Value)" >> $env:GITHUB_OUTPUT
            exit 0
          }

          $query = "New version: $env:PACKAGE_ID version $env:VERSION_NO_V"
          $candidatePrs = gh pr list -R microsoft/winget-pkgs --search "$query" --state open --json number,url,title | ConvertFrom-Json
          $candidate = $candidatePrs | Where-Object { $_.title -eq $query } | Select-Object -First 1
          if (-not $candidate) {
            $candidate = $candidatePrs | Select-Object -First 1
          }
          if (-not $candidate) {
            throw "Failed to discover winget PR URL from wingetcreate output."
          }
          "pull_request_url=$($candidate.url)" >> $env:GITHUB_OUTPUT

      - name: Sync WinGet PR checklist
        if: ${{ steps.prereq.outputs.ready == 'true' && steps.prereq.outputs.package_exists == 'true' && steps.prereq.outputs.version_exists != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.WINGET_CREATE_GITHUB_TOKEN }}
          MANIFEST_PATH: ${{ steps.winget_validate.outputs.manifest_path }}
          PR_URL: ${{ steps.winget_submit.outputs.pull_request_url }}
          RELEASE_TAG: ${{ needs.publish.outputs.tag }}
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          if ([string]::IsNullOrWhiteSpace($env:PR_URL)) {
            Write-Host "No PR URL available for checklist sync."
            exit 0
          }

          $pr = gh pr view "$env:PR_URL" --repo microsoft/winget-pkgs --json number,title,body | ConvertFrom-Json
          if (-not $pr) {
            Write-Host "Could not read PR body from $env:PR_URL"
            exit 0
          }

          $body = $pr.body
          $validatedPattern = '(?m)^- \[ \] Have you \[validated\]\(https://github\.com/microsoft/winget-pkgs/blob/master/doc/Authoring\.md#validation\) your manifest locally with `winget validate --manifest <path>`\?$'
          $installPattern = '(?m)^- \[ \] Have you tested your manifest locally with `winget install --manifest <path>`\?$'
          $schemaPattern = '(?m)^- \[ \] Does your manifest conform to the \[1.10 schema\]\(https://github\.com/microsoft/winget-pkgs/tree/master/doc/manifest/schema/1\.10\.0\)\?$'
          $body = [regex]::Replace($body, $validatedPattern, '- [x] Have you [validated](https://github.com/microsoft/winget-pkgs/blob/master/doc/Authoring.md#validation) your manifest locally with `winget validate --manifest <path>`?')
          $body = [regex]::Replace($body, $installPattern, '- [x] Have you tested your manifest locally with `winget install --manifest <path>`?')
          $body = [regex]::Replace($body, $schemaPattern, '- [x] Does your manifest conform to the [1.10 schema](https://github.com/microsoft/winget-pkgs/tree/master/doc/manifest/schema/1.10.0)?')

          if ($body -notlike "*Release validation performed by yt-vod-manager workflow run for $env:RELEASE_TAG*") {
            $evidence = "Release validation performed by yt-vod-manager workflow:`r`n- Version: $env:RELEASE_TAG`r`n- Manifest path: $env:MANIFEST_PATH`r`n- winget validate --manifest: passed`r`n- winget install --manifest: passed"
            $body = $body + "`r`n" + $evidence
          }

          gh pr edit "$env:PR_URL" --repo microsoft/winget-pkgs --body "$body"

      - name: WinGet package bootstrap notice
        if: ${{ steps.prereq.outputs.ready == 'true' && steps.prereq.outputs.package_exists != 'true' }}
        shell: pwsh
        run: |
          Write-Host "Run the first submission manually in microsoft/winget-pkgs, then later releases will auto-submit updates."

      - name: WinGet open PR exists notice
        if: ${{ steps.prereq.outputs.open_pr_exists == 'true' }}
        shell: pwsh
        run: |
          Write-Host "Open WinGet PR detected (${{ steps.prereq.outputs.open_pr_url }}). Skipping new submit; continue using the existing PR."

      - name: WinGet version already exists notice
        if: ${{ steps.prereq.outputs.ready == 'true' && steps.prereq.outputs.package_exists == 'true' && steps.prereq.outputs.version_exists == 'true' }}
        shell: pwsh
        run: |
          Write-Host "WinGet manifest version already exists in microsoft/winget-pkgs; skipping submit."
